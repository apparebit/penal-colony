% Copyright (C) 2023 by Robert Grimm

% Color emoji based on Google's Noto color emoji font for all modern
% implementations of LaTeX. For LuaLaTeX, that means using actual emoji. For the
% rest, that means PDF files.

% TODO: Create industrial-strength version that scrapes emoji names and their
% Unicode sequences from https://unicode.org/emoji/charts/full-emoji-list.html
% and then converts the corresponding SVG files from
% https://github.com/googlefonts/noto-emoji into PDF files, using rsvg-convert
% and my \Page \Group fix script.

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{emo}[2023/02/10 emo package]
\RequirePackage{graphicx}
\RequirePackage{iftex}
\ifluatex
    \RequirePackage{fontspec}
\fi

% The following list of commands effectively implements a table that maps emoji
% names to emoji. We define it for all compilers because it not only enables
% emoji generation with LuaLaTeX but also the validation of emoji names with all
% compilers. In the latter case, it doesn't matter whether the compiler can
% typeset emoji.
\newcommand\emo@emoji@biohazard{☣️}
\newcommand\emo@emoji@checkmark{✔️}
\newcommand\emo@emoji@desertisland{🏝}
\newcommand\emo@emoji@enragedface{😡}
\newcommand\emo@emoji@eu{🇪🇺}
\newcommand\emo@emoji@eye{👁}
\newcommand\emo@emoji@floppydisk{💾}
\newcommand\emo@emoji@fog{🌁}
\newcommand\emo@emoji@globeafrica{🌍}
\newcommand\emo@emoji@judge{🧑🏽‍⚖️}
\newcommand\emo@emoji@label{🏷}
\newcommand\emo@emoji@loupeleft{🔍}
\newcommand\emo@emoji@pager{📟}
\newcommand\emo@emoji@parrot{🦜}
\newcommand\emo@emoji@receipt{🧾}
\newcommand\emo@emoji@robot{🤖}
\newcommand\emo@emoji@rulertriangle{📐}
\newcommand\emo@emoji@scales{⚖️}
\newcommand\emo@emoji@stadium{🏟}
\newcommand\emo@emoji@stop{🛑}
\newcommand\emo@emoji@tabs{🗂}
\newcommand\emo@emoji@temple{🏛}
\newcommand\emo@emoji@wastebasket{🗑}

% \emo@ifdef{<name>}{<text>} includes the text only if the name is a valid. In a
% stroke of equal parts brilliance and madness, the command depends on the not
% yet defined \emo command for emitting a highly visible emoji-based error
% marker.
\newcommand\emo@ifdef[2]{%
    \ifcsname emo@emoji@#1\endcsname#2\else%
        \PackageWarning{emo}{Unknown emoji name in `\string\emo{#1}'}%
        \emo{stop} No ``#1'' \emo{stop}%
    \fi%
}

% The LuaLaTeX version of \emo{} depends on a new font family that renders Noto
% color emoji with the Harfbuzz text shaping engine. Without the latter, the
% former simply won't render. \emo simply temporarily switches to that font
% family.
\ifluatex
\newfontfamily\emo@font[Renderer=Harfbuzz]{NotoColorEmoji.ttf}
\newcommand\emo[1]{\emo@ifdef{#1}{%
    {\emo@font\csname emo@emoji@#1\endcsname}}}

% The fallback version of \emo{} just includes line art from PDF files. Those
% PDF files were generated by converting the original SVG line art for Noto
% color emoji to PDF with `rsvg-convert' and then post-processing the result
% with a custom script based on `qpdf' because at least `pdflatex' gets confused
% by \Page \Group objects.
\else
\newcommand\emo[1]{\emo@ifdef{#1}{%
    \raisebox{-0.2ex}{\includegraphics[height=1em]{./emoji/#1}}}}
\fi

% Et voilà: Color emoji for all!
\endinput
